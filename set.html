<!DOCTYPE html>
<html>
    <head>
        <meta charset='utf-8'>
        <meta http-equiv="X-UA-Compatible" content="chrome=1">
        <meta name="description" content="Login and Pay with Amazon SDK Samples : Login and Pay with Amazon SDK Sample Code">

        <script type="text/javascript">
            var host = "amzn.github.io";
            if ((host === window.location.host) && (window.location.protocol !== "https:"))
                window.location.protocol = "https";
            window.onAmazonLoginReady = function () {
                amazon.Login.setClientId('amzn1.application-oa2-client.fa79e58459cf4a30aa478fc8f79e0ef7');
                amazon.Login.setUseCookie(true);
            };
        </script>
        <script type='text/javascript' src='https://static-na.payments-amazon.com/OffAmazonPayments/us/sandbox/js/Widgets.js'></script>

        <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
        <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
        <script type="text/javascript" src="javascripts/prism.js"></script>
        <script type="text/javascript" src="javascripts/floater.js"></script>

        <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/reset.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/0.0.1/prism.min.css">
        <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/prism.css">
        <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/font-mfizz.css">
        <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

        <script type="text/javascript">
            $(document).ready(function () {
                function getURLParameter(name, source) {
                    return decodeURIComponent((new RegExp('[?|&|#]' + name + '=' +
                            '([^&;]+?)(&|#|;|$)').exec(source) || [, ""])[1].replace(/\+/g, '%20')) || null;
                }
                function getParameterByName(name) {
                    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
                    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
                            results = regex.exec(location.search);
                    return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
                }
                var access_token = getParameterByName('access_token');
                $("#access_token").val(access_token);
                $("#code_access_token").text(access_token);
                $("#place-order").on("click", function () {
                    window.location = "https://amzn.github.io/login-and-pay-with-amazon-sdk-samples/confirm.html"
                });
            });
        </script>


        <title>Login and Pay with Amazon SDK Samples</title>
    </head>

    <body>
        <div id='floater'>
            <div class='float-icon float-lang-php'><i class="step icon-php"></i></div>
            <div class='float-icon float-lang-python'><i class="step icon-python"></i></div>
            <div class='float-icon float-lang-ruby'><i class="step icon-ruby"></i></div>
        </div>

        <!-- HEADER -->
        <div id="header_wrap" class="outer">
            <header class="inner">
                <a id="forkme_banner" href="https://github.com/amzn/login-and-pay-with-amazon-sdk-samples">View on GitHub</a>

                <h1 id="project_title" style="margin-top:20px;">Pay with Amazon SDK Samples</h1>
                <h2 id="project_tagline">Pay with Amazon Simple Checkout</h2>

                <section id="downloads">
                    <a class="zip_download_link" href="https://github.com/amzn/login-and-pay-with-amazon-sdk-samples/zipball/master">Download this project as a .zip file</a>
                    <a class="tar_download_link" href="https://github.com/amzn/login-and-pay-with-amazon-sdk-samples/tarball/master">Download this project as a tar.gz file</a>
                </section>
            </header>
        </div>

        <input type="hidden" id="access_token" value="" />

        <div id="main_content_wrap" class="outer"> <!-- wrap -->
            <section id="main_content" class="inner">

                <div id="section-content">
                    <h2>Select Shipping and Payment Method</h2>

                    <p style="margin-top:20px;">Select your billing address and payment method
                        from the widgets below.</p>
                    <p>Notice in the URL above there are several parameters available.
                        The 'access_token' should be saved in order to obtain address line one and
                        two of the shipping address associated with the payment method.</p>
                    <p><pre><code class="language-javascript" id="code_access_token"></code></pre></p>
                    <p>This is known as the address consent token. It is passed to the <em>GetOrderReferenceDetails</em> API
                        call to retrieve information about the order reference Id that is generated
                        by the widgets.</p>
                    <p>If you see a error message in the widgets you will need to
                        <a onclick='startOver();' href='#'>start over</a>. This usually indicates that your session has expired.</p>


                    <div class="text-center" style="margin-top:40px;">
                        <div id="addressBookWidgetDiv" style="width:300px; height:220px; display:inline-block;"></div>
                        <div id="walletWidgetDiv" style="width:300px; height:220px; display:inline-block;"></div>
                        <div style="clear:both;"></div>
                        <div class="text-center" style="margin-top:20px;">
                            <button id="place-order" class="btn btn-lg btn-success">Place Order</button>
                        </div>
                    </div>
                </div>
            </section>
                    <section class="inner">
                        <h2>Code</h2>
                        <p>Create the widget containers.</p>
                        <pre><code class="language-markup">&#x3C;div id=&#x22;addressBookWidgetDiv&#x22; style=&#x22;width:400px; height:240px;&#x22;&#x3E;&#x3C;/div&#x3E;
&#x3C;div id=&#x22;walletWidgetDiv&#x22; style=&#x22;width:400px; height:240px;&#x22;&#x3E;&#x3C;/div&#x3E;</code></pre>

                <p>Add script to set the client Id just as you did for displaying the Pay with Amazon button.</p>
                <pre><code class="language-javascript">&#x3C;script type=&#x27;text/javascript&#x27;&#x3E;
    window.onAmazonLoginReady = function () {
        amazon.Login.setClientId('CLIENT_ID');
        amazon.Login.setUseCookie(true);
    };
&#x3C;/script&#x3E;</code></pre>

                <p>Import widgets javascript. This must be loaded after you set the client Id above.</p>
                <pre><code class="language-javascript">&#x3C;script type=&#x27;text/javascript&#x27; src=&#x27;https://static-na.payments-amazon.com/OffAmazonPayments/us/sandbox/js/Widgets.js&#x27;&#x3E;&#x3C;/script&#x3E;</code></pre>

                <p>Add the widgets code. You can use the <em>onOrderReferenceCreate</em> method to
                    obtain information about the order reference Id.</p>
                <pre><code class="language-javascript">&#x3C;script type=&#x22;text/javascript&#x22;&#x3E;
    new OffAmazonPayments.Widgets.AddressBook({
        sellerId: 'MERCHANT_ID';,
        onOrderReferenceCreate: function (orderReference) {
           orderReferenceId = orderReference.getAmazonOrderReferenceId();
        },
        onAddressSelect: function () {
            // do stuff here like recalculate tax and/or shipping
        },
        design: {
            designMode: &#x27;responsive&#x27;
        },
        onError: function (error) {
            // your error handling code
        }
    }).bind(&#x22;addressBookWidgetDiv&#x22;);

    new OffAmazonPayments.Widgets.Wallet({
        sellerId: 'MERCHANT_ID',
        onPaymentSelect: function () {
        },
        design: {
            designMode: &#x27;responsive&#x27;
        },
        onError: function (error) {
            // your error handling code
        }
    }).bind(&#x22;walletWidgetDiv&#x22;);
&#x3C;/script&#x3E;</code></pre>

                <p>These are the back-end API calls to <em>SetOrderReferenceDetails</em> and <em>GetOrderReferenceDetails</em>.
                    These API calls set the order total to 175.00 and gets the order reference details. The Amazon Order Reference Id is created when
                    the widgets load. (see the 'orderReferenceId' variable in the javascript above)</p>
                    <p>The Pay with Amazon client will be initialized here and used throughout the rest of the sample.</p>
                    <div class="alert alert-danger" role="alert">The below is sample code. Your MWS Keys should be stored in a secure location.</div>
                <pre class="l-python"><code class="language-python">from pay_with_amazon.client import PayWithAmazonClient

client = PayWithAmazonClient(
    mws_access_key='ACCESS_KEY',
    mws_secret_key='SECRET_KEY'
    merchant_id='MERCHANT_ID',
    sandbox=True,
    region='na',
    currency_code='USD')

order_reference_id = 'AMAZON_ORDER_REFERENCE_ID'

response = client.set_order_reference_details(
    amazon_order_reference_id=order_reference_id,
    order_total='175.00')

if response.success:
    response = client.get_order_reference_details(
        amazon_order_reference_id=order_reference_id,
        address_consent_token=session['access_token'])

pretty = json.dumps(
    json.loads(
        response.to_json()),
    indent=4)
return pretty</code></pre>



                <pre class="l-php"><code class="language-php">namespace PayWithAmazon;

session_start();

require_once '../PayWithAmazon/Client.php';

$config =array( 'merchant_id'   => 'MERCHANT_ID',
                'access_key'    => 'ACCESS_KEY',
                'secret_key'    => 'SECRET_KEY',
                'client_id'     => 'CLIENT_ID'
                'currency_code' => 'usd',
                'region'        => 'us',
                'sandbox'   => true);

// Instantiate the client object with the configuration
$client = new Client($config);
$requestParameters = array();

// Create the parameters array to set the order
$requestParameters['amazon_order_reference_id'] = 'AMAZON_ORDER_REFERENCE_ID';
$requestParameters['amount']            = '175.00';
$requestParameters['currency_code']     = 'USD';
$requestParameters['seller_note']   = 'Love this sample';
$requestParameters['seller_order_id']   = '123456-TestOrder-123456';
$requestParameters['store_name']        = 'Saurons collectibles in Mordor';

// Set the Order details by making the SetOrderReferenceDetails API call
$response = $client->SetOrderReferenceDetails($requestParameters);

// If the API call was a success Get the Order Details by making the GetOrderReferenceDetails API call
if($client->success)
{
    $requestParameters['address_consent_token'] = null;
    $response = $client->GetOrderReferenceDetails($requestParameters);
}
// Pretty print the Json and then echo it for the Ajax success to take in
$json = json_decode($response->toJson());
echo json_encode($json, JSON_PRETTY_PRINT);</code></pre>






                <pre class="l-ruby"><code class="language-ruby">require 'pay_with_amazon'

access_key = 'ACCESS_KEY'
secret_key = 'SECRET_KEY'
merchant_id = 'MERCHANT_ID'

client = PayWithAmazon::Client.new(
    access_key,
    secret_key,
    merchant_id,
    region: :na, # default: :na
    sandbox: true, # default: false
    currency_code: :usd) # default: :usd

amazon_order_reference_id = 'AMAZON_ORDER_REFERENCE_ID'
amount = '175.00'

response = client.set_order_reference_details(
    amazon_order_reference_id,
    amount)

if response.success
    response = client.get_order_reference_details(
        amazon_order_reference_id,
        address_consent_token: access_token)
end

response_hash = Hash.from_xml(response.body)
return response_hash</code></pre>




                <p>This is the response from the previous API call.</p>
                <pre><code class='language-markup'>
{
    "GetOrderReferenceDetailsResponse": {
        "ResponseMetadata": {
            "RequestId": "9816e385-9d90-4c09-a798-3942f7b6d347"
        },
        "GetOrderReferenceDetailsResult": {
            "OrderReferenceDetails": {
                "Destination": {
                    "DestinationType": "Physical",
                    "PhysicalDestination": {
                        "Phone": "800-000-0000",
                        "CountryCode": "US",
                        "City": "New York",
                        "StateOrRegion": "NY",
                        "AddressLine1": "Happy Happy Toys",
                        "Name": "Tom Thompson",
                        "PostalCode": "10016",
                        "AddressLine2": "45 Big Apple Way"
                    }
                },
                "Buyer": {
                    "Name": "Tom",
                    "Email": "tomt@example.org"
                },
                "IdList": null,
                "SellerOrderAttributes": null,
                "OrderTotal": {
                    "CurrencyCode": "USD",
                    "Amount": "175.00"
                },
                "ExpirationTimestamp": "2015-10-31T20:45:51.747Z",
                "CreationTimestamp": "2015-05-04T20:45:51.747Z",
                "AmazonOrderReferenceId": "S01-5046426-7112299",
                "ReleaseEnvironment": "Sandbox",
                "OrderReferenceStatus": {
                    "State": "Draft"
                }
            }
        }
    }
}</code></pre>

            </section>
        </div><!-- end wrap -->

        <!-- FOOTER  -->
        <div id="footer_wrap" class="outer">
            <footer class="inner">
                <p class="copyright">Login and Pay with Amazon SDK Samples maintained by <a href="https://github.com/amzn">amzn</a></p>
                <p>Published with <a href="https://pages.github.com">GitHub Pages</a></p>
            </footer>
        </div>


        <script type="text/javascript">
            new OffAmazonPayments.Widgets.AddressBook({
                sellerId: 'AQR8184NJXADU',
                onOrderReferenceCreate: function (orderReference) {
                  orderReference.getAmazonOrderReferenceId();
                },
                onAddressSelect: function (orderReference) {
                },
                design: {
                    designMode: 'responsive'
                },
                onError: function (error) {
                    // your error handling code
                }
            }).bind("addressBookWidgetDiv");

            new OffAmazonPayments.Widgets.Wallet({
                sellerId: 'AQR8184NJXADU',
                onPaymentSelect: function (orderReference) {
                },
                design: {
                    designMode: 'responsive'
                },
                onError: function (error) {
                    // your error handling code
                }
            }).bind("walletWidgetDiv");
        </script>


    </body>
</html>
